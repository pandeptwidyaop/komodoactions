name: 'Komodo Stack Deploy'
description: 'Deploy a stack on Komodo server using API'
author: 'pandeptwidyaop'

inputs:
  komodo-url:
    description: 'Komodo server URL (e.g., https://komodo.example.com)'
    required: true
  api-key:
    description: 'Komodo API key'
    required: true
  api-secret:
    description: 'Komodo API secret'
    required: true
  stack-name:
    description: 'Name of the stack to deploy'
    required: true
  services:
    description: 'Services to deploy (comma-separated, e.g., "app,db" or leave empty for all services)'
    required: false
    default: ''
  wait-for-completion:
    description: 'Wait for deployment to complete (true/false)'
    required: false
    default: 'true'
  show-logs:
    description: 'Show detailed deployment logs (true/false)'
    required: false
    default: 'true'

outputs:
  update-id:
    description: 'The update ID returned by Komodo'
    value: ${{ steps.deploy.outputs.update-id }}
  status:
    description: 'The final status of the deployment'
    value: ${{ steps.deploy.outputs.status }}

runs:
  using: 'composite'
  steps:
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      run: npm ci --production
      shell: bash
      working-directory: ${{ github.action_path }}

    - name: Run action
      id: deploy
      run: node main.js
      shell: bash
      working-directory: ${{ github.action_path }}
      env:
        INPUT_KOMODO-URL: ${{ inputs.komodo-url }}
        INPUT_API-KEY: ${{ inputs.api-key }}
        INPUT_API-SECRET: ${{ inputs.api-secret }}
        INPUT_STACK-NAME: ${{ inputs.stack-name }}
        INPUT_SERVICES: ${{ inputs.services }}
        INPUT_WAIT-FOR-COMPLETION: ${{ inputs.wait-for-completion }}
        INPUT_SHOW-LOGS: ${{ inputs.show-logs }}
  